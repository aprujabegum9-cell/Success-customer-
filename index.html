<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>খিদে লাগছে | Feeling Hungry Premium</title>
    
    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Professional Map (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #ef4444;
            --bg-light: #f8fafc;
            --card-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.08);
        }

        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #ffffff; 
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* PREMIUM ADVERTISING BAR */
        .adv-container {
            background: #ffe4e6; 
            height: 45px;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: sticky;
            top: 0;
            z-index: 1500;
            border-bottom: 1px solid #fecaca;
        }

        .adv-scroller {
            white-space: nowrap;
            display: inline-block;
            animation: marquee 20s linear infinite;
            font-weight: 800;
            color: #be123c;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        @keyframes marquee {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }

        .app-view { display: none; min-height: 100vh; }
        .app-view.active { display: block; }
        .auth-view { display: none; min-height: 100vh; background: #ffffff; flex-direction: column; }
        .auth-view.active { display: flex; }

        .logo-circle {
            background: var(--primary);
            width: 120px; height: 120px;
            border-radius: 40px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.3);
        }

        .input-container {
            background: #f1f5f9; border-radius: 25px; padding: 22px 30px;
            margin-bottom: 20px; border: 2px solid transparent; transition: 0.3s;
        }

        .input-container:focus-within {
            background: white; border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.05);
        }

        .input-container input, .input-container textarea {
            background: transparent; outline: none; width: 100%;
            font-weight: 700; font-size: 17px; color: #334155;
        }

        .btn-action {
            background: var(--primary); color: white; padding: 22px;
            border-radius: 25px; font-weight: 900; font-size: 16px;
            text-transform: uppercase; box-shadow: 0 15px 35px rgba(239, 68, 68, 0.25);
            width: 100%; transition: 0.3s;
        }

        #reg-map, #profile-map {
            height: 400px; border-radius: 40px;
            margin: 20px 0; border: 8px solid #f1f5f9;
            z-index: 10;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px); height: 95px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #f1f5f9; border-radius: 40px 40px 0 0;
            z-index: 1000;
        }

        .nav-item { color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .nav-item.active-nav { color: var(--primary); font-weight: 900; }

        .search-box {
            background: #ecfdf5; 
            border-radius: 25px; padding: 20px 25px;
            display: flex; align-items: center; gap: 15px; margin: 25px 0;
            border: 1px solid #d1fae5; 
        }

        .res-card {
            background: white; border-radius: 40px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1.5px solid #f1f5f9;
            display: flex; align-items: center; gap: 20px; margin-bottom: 15px;
        }

        .food-card {
            background: white; border-radius: 35px; padding: 15px;
            border: 1px solid #f1f5f9; box-shadow: 0 5px 15px rgba(0,0,0,0.02);
            display: flex; align-items: center; gap: 15px;
        }

        @keyframes slideInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .animate-up { animation: slideInUp 0.6s cubic-bezier(0.23, 1, 0.32, 1); }

        .closed-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .order-action-btn {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 14px;
            transition: 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .order-action-btn:active { transform: scale(0.9); }

        #tracking-modal {
            position: fixed; inset: 0; background: white; z-index: 5000;
            display: none; flex-direction: column;
        }
        #tracking-map { flex: 1; width: 100%; }
        .track-header { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; }

        #notification-toast {
            position: fixed; top: -150px; left: 15px; right: 15px;
            background: white; border-radius: 30px; padding: 20px;
            box-shadow: 0 25px 60px -12px rgba(0,0,0,0.25);
            z-index: 10000; display: flex; align-items: center; gap: 18px;
            transition: 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            border: 1px solid rgba(0,0,0,0.05);
        }
        #notification-toast.show { top: 20px; }

        .chat-bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; margin-bottom: 10px; font-size: 14px; font-weight: 600; line-height: 1.4; }
        .chat-sent { background: #ef4444; color: white; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
        .chat-received { background: #f1f5f9; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }
    </style>
</head>
<body onclick="enableAudio()">

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="chat-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <div id="notification-toast">
        <div id="notif-icon-bg" class="w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg shrink-0">
            <i id="notif-icon" class="fas fa-bell"></i>
        </div>
        <div class="flex-1">
            <h4 id="notif-title" class="font-black text-[16px] italic leading-none text-slate-800 uppercase tracking-tighter">অর্ডার আপডেট</h4>
            <p id="notif-msg" class="text-[13px] font-bold text-slate-500 mt-2 leading-tight">আপনার অর্ডারের অবস্থা পরিবর্তিত হয়েছে।</p>
        </div>
        <button onclick="hideNotif()" class="text-slate-300 hover:text-red-500 transition-colors px-2"><i class="fas fa-times text-xl"></i></button>
    </div>

    <div id="store-closed-screen" class="closed-overlay hidden">
        <i class="fas fa-store-slash text-6xl text-red-500 mb-6"></i>
        <h1 class="text-3xl font-black text-gray-800">সার্ভিস বর্তমানে বন্ধ</h1>
        <p class="text-gray-500 font-bold mt-2">আমরা শীঘ্রই ফিরছি!</p>
    </div>

    <div id="tracking-modal">
        <div class="track-header">
            <button onclick="closeTracking()" class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
            <div>
                <h3 class="font-black text-lg italic leading-none">Order Tracking</h3>
                <p id="track-status" class="text-[10px] text-emerald-500 font-black uppercase tracking-widest mt-1">লাইভ লোকেশন ট্র্যাকিং</p>
            </div>
        </div>
        <div id="tracking-map"></div>
        <div class="p-6 bg-white shadow-[0_-10px_30px_rgba(0,0,0,0.05)] rounded-t-[3rem]">
             <div class="flex items-center gap-4">
                 <div class="w-14 h-14 bg-red-100 rounded-2xl flex items-center justify-center text-red-500 text-2xl">
                     <i class="fas fa-motorcycle"></i>
                 </div>
                 <div>
                     <p class="text-[10px] font-black text-slate-400 uppercase">Delivery Hero</p>
                     <h4 class="font-black text-xl italic" id="track-rider-name">Rider is assigning...</h4>
                 </div>
                 <div class="ml-auto flex gap-2">
                    <button id="track-chat-btn" class="w-12 h-12 bg-emerald-500 text-white rounded-full flex items-center justify-center shadow-lg shadow-emerald-200"><i class="fas fa-comment-dots"></i></button>
                    <a id="track-rider-call" href="#" class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-blue-200"><i class="fas fa-phone"></i></a>
                 </div>
             </div>
        </div>
    </div>

    <div id="chat-modal" class="fixed inset-0 bg-white z-[6000] hidden flex flex-col">
        <header class="p-6 border-b flex justify-between items-center bg-white sticky top-0">
            <div class="flex items-center gap-4">
                <button onclick="closeChat()" class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center border"><i class="fas fa-arrow-left"></i></button>
                <div>
                    <h3 id="chat-title" class="font-black text-lg italic leading-none uppercase">Rider Chat</h3>
                    <p class="text-[10px] text-emerald-500 font-black uppercase tracking-widest mt-1">Online</p>
                </div>
            </div>
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-500"><i class="fas fa-headset"></i></div>
        </header>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col bg-slate-50/50"></div>
        <div class="p-6 bg-white border-t flex gap-3 items-center">
            <div class="flex-1 bg-slate-100 rounded-3xl px-6 py-4 border focus-within:border-red-500 transition-all">
                <input type="text" id="chat-input" placeholder="মেসেজ লিখুন..." class="bg-transparent outline-none w-full font-bold text-slate-700">
            </div>
            <button onclick="sendMessage()" class="w-14 h-14 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg shadow-red-200 active:scale-90 transition-all">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="view-login" class="auth-view active p-10 justify-center text-center">
        <div class="logo-circle animate-up">
            <i class="fas fa-utensils text-white text-5xl"></i>
        </div>
        <h1 class="text-4xl font-black italic mb-2 tracking-tighter">Are you hungry <span class="text-red-500">?</span></h1>
        <p class="text-slate-400 font-bold mb-16">আপনার পছন্দের খাবার এখন হাতের নাগালে।</p>
        <div class="max-w-md mx-auto w-full">
            <div class="input-container flex items-center gap-4">
                <i class="fas fa-phone-alt text-red-500"></i>
                <input type="number" id="login-phone" placeholder="017XXXXXXXX" class="font-black text-xl">
            </div>
            <button onclick="handleLogin()" class="btn-action">Login</button>
            <p class="mt-10 font-bold text-slate-400">নতুন ইউজার? <br>
                <button onclick="showAuth('register')" class="text-red-500 font-black underline mt-3">অ্যাকাউন্ট তৈরি করুন</button>
            </p>
        </div>
    </div>

    <div id="view-register" class="auth-view p-8 pt-12 overflow-y-auto">
        <button onclick="showAuth('login')" class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center mb-8 border"><i class="fas fa-arrow-left text-slate-400"></i></button>
        <h1 class="text-3xl font-black text-red-600 italic mb-10">নতুন অ্যাকাউন্ট</h1>
        <div class="space-y-4 animate-up">
            <div class="input-container"><input type="text" id="reg-name" placeholder="আপনার নাম"></div>
            <div class="input-container"><input type="number" id="reg-phone" placeholder="মোবাইল নম্বর"></div>
            <div class="input-container"><input type="text" id="reg-address" placeholder="ম্যাপ থেকে ঠিকানা লোড হবে..." readonly></div>
            <div class="flex justify-center -mt-2 mb-2">
                <button onclick="autoLocate('reg')" class="bg-blue-600 text-white font-black px-8 py-4 rounded-[2rem] shadow-xl active:scale-95 transition-all text-sm uppercase flex items-center gap-3">
                    <i class="fas fa-crosshairs text-lg animate-pulse"></i> Auto Detect My Location
                </button>
            </div>
            <div class="bg-slate-50 p-4 rounded-[2.5rem] border mb-6">
                <div id="reg-map"></div>
            </div>
            <button onclick="handleRegistration()" class="btn-action">Create Account</button>
        </div>
    </div>

    <div id="view-customer" class="app-view">
        <div class="adv-container">
            <div id="adv-notice-text" class="adv-scroller">✨ No Extra Tax, No Hidden VAT! Pay Only For Your Food. ✨</div>
        </div>
        <div id="page-home" class="page-content p-6 pb-40">
            <div class="mt-6 mb-2">
                <h2 class="text-4xl font-black italic tracking-tighter text-slate-800 leading-none">Feeling hungry?</h2>
                <p class="text-[11px] text-slate-400 font-black uppercase tracking-widest mt-2">আপনার পছন্দের রেস্টুরেন্ট খুঁজুন</p>
            </div>
            <div class="search-box">
                <i class="fas fa-search text-emerald-500"></i>
                <input type="text" oninput="filterRes(this.value)" placeholder="রেস্টুরেন্ট সার্চ করুন..." class="bg-transparent outline-none w-full font-bold">
            </div>
            <div id="res-list" class="grid gap-1 animate-up"></div>
        </div>
        <div id="page-orders" class="page-content p-6 pb-40 hidden">
            <h2 class="text-3xl font-black italic mb-8">My orders</h2>
            <div id="my-orders-list" class="grid gap-5"></div>
        </div>
        <div id="page-profile" class="page-content p-6 pb-40 hidden">
            <h2 class="text-3xl font-black italic mb-8">প্রোফাইল সেটিংস</h2>
            <div class="space-y-4">
                <div class="input-container"><input type="text" id="prof-name"></div>
                <div class="input-container opacity-60"><input type="number" id="prof-phone" readonly></div>
                <div class="input-container"><input type="text" id="prof-address" readonly></div>
                <div class="flex justify-center -mt-2 mb-2">
                    <button onclick="autoLocate('prof')" class="bg-emerald-500 text-white font-black px-8 py-4 rounded-[2rem] shadow-xl active:scale-95 transition-all text-sm uppercase flex items-center gap-3">
                        <i class="fas fa-crosshairs text-lg animate-pulse"></i> Auto Update Address
                    </button>
                </div>
                <div id="profile-map"></div>
                <button onclick="updateProfile()" class="btn-action bg-emerald-500">সেভ করুন</button>
                <button onclick="handleLogout()" class="w-full text-red-500 font-black text-sm mt-6 uppercase">লগ আউট</button>
            </div>
        </div>
        <div id="page-menu" class="page-content hidden">
            <div class="sticky top-11 bg-white/95 backdrop-blur-md p-6 flex items-center gap-5 z-50 border-b">
                <button onclick="switchCustPage('home')" class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center border"><i class="fas fa-arrow-left"></i></button>
                <h2 id="menu-res-title" class="font-black text-xl italic uppercase truncate">Menu</h2>
            </div>
            <div id="food-list-container" class="p-6 grid gap-4 pb-48"></div>
        </div>
        <nav class="bottom-nav">
            <button onclick="switchCustPage('home')" id="nav-home" class="nav-item active-nav"><i class="fas fa-home text-2xl"></i><span class="text-[10px] uppercase font-black">Home</span></button>
            <button onclick="switchCustPage('orders')" id="nav-orders" class="nav-item"><i class="fas fa-receipt text-2xl"></i><span class="text-[10px] uppercase font-black">Orders</span></button>
            <button onclick="switchCustPage('profile')" id="nav-profile" class="nav-item"><i class="fas fa-user-circle text-2xl"></i><span class="text-[10px] uppercase font-black">Profile</span></button>
        </nav>
        <div id="cart-float" class="hidden fixed bottom-28 left-6 right-6 bg-gray-900 text-white p-5 rounded-[2.5rem] flex justify-between items-center z-[100] shadow-2xl animate-up">
            <div>
                <p id="cart-qty" class="text-[9px] font-bold text-slate-400 uppercase">0 টি খাবার</p>
                <p id="cart-sum" class="text-2xl font-black text-red-500 italic">৳ 0</p>
            </div>
            <button onclick="openCheckout()" class="bg-red-600 px-8 py-3 rounded-2xl font-black text-sm uppercase italic">চেকআউট</button>
        </div>
    </div>

    <div id="checkout-modal" class="hidden fixed inset-0 bg-black/75 backdrop-blur-xl z-[2000] flex items-end">
        <div class="bg-white w-full rounded-t-[4rem] p-8 animate-up max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black italic">Order Review</h3>
                <button onclick="document.getElementById('checkout-modal').classList.add('hidden')" class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="checkout-items-list" class="mb-6 divide-y border-t border-b border-dashed"></div>
            <div class="mb-6">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-3">Add a tip for rider</p>
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar" id="tip-options-container">
                    <button onclick="setTip(20)" id="tip-20" class="tip-btn px-6 py-3 rounded-2xl bg-slate-50 border border-slate-100 font-black text-sm transition-all">৳ 20</button>
                    <button onclick="setTip(40)" id="tip-40" class="tip-btn px-6 py-3 rounded-2xl bg-slate-50 border border-slate-100 font-black text-sm transition-all">৳ 40</button>
                    <button onclick="setTip(60)" id="tip-60" class="tip-btn px-6 py-3 rounded-2xl bg-slate-50 border border-slate-100 font-black text-sm transition-all">৳ 60</button>
                </div>
            </div>
            <div class="bg-slate-50 p-6 rounded-[2.5rem] mb-6 space-y-2">
                <div class="flex justify-between font-bold text-slate-400 text-xs"><span>Subtotal</span><span id="bill-sub">৳ 0</span></div>
                <div class="flex justify-between font-bold text-blue-600 text-xs"><span>Delivery charges</span><span id="bill-delivery">৳ 0</span></div>
                <div id="tip-row" class="hidden flex justify-between font-bold text-emerald-600 text-xs"><span>Rider Tip</span><span id="bill-tip">৳ 0</span></div>
                <div class="flex justify-between text-2xl font-black pt-4 border-t"><span>Total bill</span><span id="final-bill-sum" class="text-red-600">৳ 0</span></div>
            </div>
            <button onclick="placeFinalOrder()" class="btn-action">Confirm Order.</button>
            <button onclick="document.getElementById('checkout-modal').classList.add('hidden')" class="w-full mt-4 text-gray-400 font-bold text-xs uppercase">Go Back.</button>
        </div>
    </div>

    <script>
        // আপনার দেওয়া MapTiler Key
        const MAPTILER_KEY = "cOMWR960XrzMsoEW2ktI";
        const TILE_URL = `https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`;
        const ATTRIBUTION = '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        const firebaseConfig = {
            apiKey: "AIzaSyD_TytbX1kd4SKQ5uHZfd5XVGwdw0gzUOE",
            authDomain: "feeling-hungry-102a9.firebaseapp.com",
            databaseURL: "https://feeling-hungry-102a9-default-rtdb.firebaseio.com",
            projectId: "feeling-hungry-102a9",
            storageBucket: "feeling-hungry-102a9.firebasestorage.app",
            messagingSenderId: "736201265500",
            appId: "1:736201265500:web:7b7064b314247c02ad7199"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let user = null, cartData = {}, activeRes = null, resCache = [];
        let rMap, rMarker, pMap, pMarker, tMap;
        let adminSettings = { adminDeliveryFee: 0, perKmFee: 0, isOpen: true, noticeText: "✨ No Tax, No VAT! Pay Only For Your Food. ✨" };
        let selectedTip = 0, activeChatOrderId = null;
        let lastKnownOrderStates = {}; 
        let appStartTime = Date.now(); 
        
        let riderMarker = null;
        let riderListener = null;

        function enableAudio() {
            const sound = document.getElementById('notif-sound');
            sound.play().then(() => { sound.pause(); sound.currentTime = 0; }).catch(e => console.log("Audio waiting"));
        }

        function syncAdminSettings() {
            db.ref('appSettings').on('value', snap => {
                const data = snap.val();
                if(data) { adminSettings = data; if(data.noticeText) document.getElementById('adv-notice-text').innerText = data.noticeText; }
                if(!adminSettings.isOpen) document.getElementById('store-closed-screen').classList.remove('hidden');
            });
        }

        function startOrderMonitor() {
            db.ref('orders').orderByChild('customerPhone').equalTo(user.phone).on('value', snap => {
                snap.forEach(child => {
                    const orderId = child.key, order = child.val();
                    if(!lastKnownOrderStates[orderId]) { lastKnownOrderStates[orderId] = { status: order.status }; return; }
                    const oldStatus = lastKnownOrderStates[orderId].status;
                    if(order.status !== oldStatus) {
                        let title = "Update", msg = "", icon = "fa-bell", color = "bg-blue-600";
                        switch(order.status) {
                            case "ACCEPTED": title = "Order Accepted"; msg = `${order.restaurantName} আপনার অর্ডার গ্রহণ করেছে।`; icon = "fa-check-double"; color = "bg-emerald-500"; break;
                            case "PICKED UP": title = "Picked Up"; msg = `রাইডার আপনার খাবার নিয়ে রেস্টুরেন্ট থেকে রওয়ানা দিয়েছে।`; icon = "fa-motorcycle"; color = "bg-orange-500"; break;
                            case "ARRIVED": title = "Rider Arrived"; msg = `রাইডার আপনার ঠিকানায় পৌঁছেছে। অনুগ্রহ করে খাবার সংগ্রহ করুন।`; icon = "fa-map-marker-alt"; color = "bg-blue-600"; break;
                            case "DELIVERED": title = "Completed"; msg = `আপনার অর্ডারটি সফলভাবে পৌঁছে দেওয়া হয়েছে। উপভোগ করুন!`; icon = "fa-heart"; color = "bg-red-600"; break;
                        }
                        showNotif(title, msg, icon, color);
                        lastKnownOrderStates[orderId].status = order.status;
                    }
                });
            });
        }

        function startChatMonitor() {
            db.ref('orders').orderByChild('customerPhone').equalTo(user.phone).on('child_added', snap => {
                const orderId = snap.key;
                db.ref(`orders/${orderId}/chat`).limitToLast(1).on('child_added', msgSnap => {
                    const msg = msgSnap.val();
                    if (msg.sender === 'rider' && msg.timestamp > appStartTime) {
                        if (!activeChatOrderId || activeChatOrderId !== orderId || document.getElementById('chat-modal').classList.contains('hidden')) {
                            showNotif("Rider Message", msg.text, "fa-comment-dots", "bg-emerald-500");
                        }
                    }
                });
            });
        }

        function showNotif(title, msg, icon, colorClass) {
            const toast = document.getElementById('notification-toast');
            document.getElementById('notif-title').innerText = title;
            document.getElementById('notif-msg').innerText = msg;
            document.getElementById('notif-icon-bg').className = `w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg shrink-0 ${colorClass}`;
            document.getElementById('notif-icon').className = `fas ${icon}`;
            toast.classList.add('show');
            try { document.getElementById('notif-sound').play(); } catch(e) {}
            setTimeout(hideNotif, 8000);
        }

        function hideNotif() { document.getElementById('notification-toast').classList.remove('show'); }

        function openChat(orderId, riderName) {
            activeChatOrderId = orderId;
            document.getElementById('chat-title').innerText = riderName || "Rider Chat";
            document.getElementById('chat-modal').classList.remove('hidden');
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = "";
            db.ref(`orders/${orderId}/chat`).off();
            db.ref(`orders/${orderId}/chat`).on('child_added', snap => {
                const msg = snap.val();
                const type = msg.sender === 'customer' ? 'chat-sent' : 'chat-received';
                chatBox.innerHTML += `<div class="chat-bubble ${type}">${msg.text}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
                if(msg.sender === 'rider' && msg.timestamp > appStartTime) document.getElementById('chat-sound').play().catch(e => {});
            });
        }
        function closeChat() { document.getElementById('chat-modal').classList.add('hidden'); if(activeChatOrderId) db.ref(`orders/${activeChatOrderId}/chat`).off(); }
        function sendMessage() {
            const input = document.getElementById('chat-input'), text = input.value.trim();
            if(!text || !activeChatOrderId) return;
            db.ref(`orders/${activeChatOrderId}/chat`).push({ sender: 'customer', text: text, timestamp: Date.now() });
            input.value = "";
        }

        function showAuth(v) { document.querySelectorAll('.auth-view, .app-view').forEach(e => e.classList.remove('active')); document.getElementById(`view-${v}`).classList.add('active'); if(v === 'register') initMap('reg'); }
        function handleLogin() {
            const ph = document.getElementById('login-phone').value; if(!ph) return alert("Phone needed");
            db.ref('users/' + ph).once('value', snap => { if(snap.exists()){ user = snap.val(); localStorage.setItem('fh_user', JSON.stringify(user)); startApp(); } else alert("অ্যাকাউন্ট পাওয়া যায়নি!"); });
        }
        function handleRegistration() {
            const n = document.getElementById('reg-name').value, p = document.getElementById('reg-phone').value, a = document.getElementById('reg-address').value;
            if(!n || !p) return alert("সব ঘর পূরণ করুন!");
            const pos = rMarker.getLatLng();
            db.ref('users/'+p).set({ name: n, phone: p, address: a, lat: pos.lat, lng: pos.lng }).then(() => { alert("সফল হয়েছে!"); showAuth('login'); });
        }
        async function fetchAddress(lat, lng, id) { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`); const d = await res.json(); document.getElementById(id).value = d.display_name; } catch(e){} }
        
        // ম্যাপের টাইলস আপডেট করা হয়েছে
        function initMap(t) {
            setTimeout(() => {
                if(t === 'reg' && !rMap) { 
                    rMap = L.map('reg-map').setView([23.81, 90.41], 13); 
                    L.tileLayer(TILE_URL, { attribution: ATTRIBUTION }).addTo(rMap); 
                    rMarker = L.marker([23.81, 90.41], {draggable: true}).addTo(rMap); 
                    rMarker.on('dragend', (e) => fetchAddress(e.target.getLatLng().lat, e.target.getLatLng().lng, 'reg-address')); 
                }
                else if(t === 'prof' && !pMap) { 
                    pMap = L.map('profile-map').setView([user.lat||23.8, user.lng||90.4], 15); 
                    L.tileLayer(TILE_URL, { attribution: ATTRIBUTION }).addTo(pMap); 
                    pMarker = L.marker([user.lat||23.8, user.lng||90.4], {draggable: true}).addTo(pMap); 
                    pMarker.on('dragend', (e) => fetchAddress(e.target.getLatLng().lat, e.target.getLatLng().lng, 'prof-address')); 
                }
            }, 500);
        }

        function autoLocate(t) { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { const ll = [pos.coords.latitude, pos.coords.longitude]; if(t === 'reg') { rMap.setView(ll, 17); rMarker.setLatLng(ll); fetchAddress(ll[0], ll[1], 'reg-address'); } else { pMap.setView(ll, 17); pMarker.setLatLng(ll); fetchAddress(ll[0], ll[1], 'prof-address'); } }); } }
        function getDistance(la1, lo1, la2, lo2) { const R = 6371; const dLat = (la2-la1)*Math.PI/180; const dLon = (lo2-lo1)*Math.PI/180; const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2); return R*(2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); }
        function startApp() { document.querySelectorAll('.auth-view, .app-view').forEach(v => v.classList.remove('active')); document.getElementById('view-customer').classList.add('active'); document.getElementById('prof-name').value = user.name; document.getElementById('prof-phone').value = user.phone; document.getElementById('prof-address').value = user.address||""; syncAdminSettings(); loadRestaurants(); startOrderMonitor(); startChatMonitor(); }
        function switchCustPage(id) { document.querySelectorAll('.page-content').forEach(e => e.classList.add('hidden')); document.getElementById(`page-${id}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active-nav')); document.getElementById(`nav-${id||'home'}`)?.classList.add('active-nav'); if(id==='profile') initMap('prof'); if(id==='orders') loadOrderHistory(); }
        
        function loadRestaurants() { db.ref('restaurants').on('value', snap => { resCache = []; snap.forEach(c => { if(c.val().status === "APPROVED") resCache.push(c.val()); }); renderResGrid(resCache); }); }
        
        function renderResGrid(d) { 
            const l = document.getElementById('res-list'); 
            l.innerHTML = ""; 
            d.forEach(r => { 
                let distText = "Calculating...";
                let timeText = "-- mins";
                if(user && user.lat && r.lat) {
                    const dist = getDistance(user.lat, user.lng, r.lat, r.lng);
                    distText = dist.toFixed(1) + " KM";
                    const travelTime = Math.round((dist / 20) * 60);
                    timeText = (travelTime + 15) + " mins";
                }
                l.innerHTML += `
                <div onclick="openMenu('${r.idNo}', '${r.name}')" class="res-card active:scale-95 transition-all">
                    <img src="${r.logo||''}" class="w-20 h-20 rounded-3xl object-cover shadow-md">
                    <div class="flex-1">
                        <h3 class="font-black text-xl italic uppercase text-slate-800">${r.name}</h3>
                        <div class="flex items-center gap-3 mt-1">
                            <span class="text-[11px] font-black text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-lg border border-emerald-100 flex items-center gap-1">
                                <i class="fas fa-location-dot text-[9px]"></i> ${distText}
                            </span>
                            <span class="text-[11px] font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded-lg border border-blue-100 flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i> ${timeText}
                            </span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300"></i>
                </div>`; 
            }); 
        }

        function filterRes(q) { renderResGrid(resCache.filter(r => r.name.toLowerCase().includes(q.toLowerCase()))); }
        function openMenu(id, name) {
            activeRes = resCache.find(r => r.idNo == id); cartData = {}; updateCartUI(); document.getElementById('menu-res-title').innerText = name; switchCustPage('menu');
            db.ref(`menus/${id}`).on('value', snap => { const c = document.getElementById('food-list-container'); c.innerHTML = ""; snap.forEach(child => { const f = child.val(); if(f.available===false) return; const sn = f.name.replace(/['"\s]+/g, ''); c.innerHTML += `<div class="food-card animate-up"><img src="${f.image}" class="w-20 h-20 rounded-2xl object-cover"><div class="flex-1"><h4 class="font-black text-lg">${f.name}</h4><p class="text-red-600 font-black text-xl italic">৳ ${f.price}</p></div><div class="flex items-center gap-3 bg-slate-50 p-1.5 rounded-2xl border"><button onclick="modQty('${f.name}', ${f.price}, -1, '${sn}')" class="w-10 h-10 rounded-xl bg-white shadow-sm">-</button><span id="iq-${sn}" class="font-black">0</span><button onclick="modQty('${f.name}', ${f.price}, 1, '${sn}')" class="w-10 h-10 rounded-xl bg-red-600 text-white">+</button></div></div>`; }); });
        }
        function modQty(n, p, c, sn) { if(!cartData[n]) cartData[n] = { price: p, qty: 0 }; cartData[n].qty += c; if(cartData[n].qty <= 0) delete cartData[n]; const el = document.getElementById(`iq-${sn}`); if(el) el.innerText = cartData[n] ? cartData[n].qty : "0"; updateCartUI(); }
        function updateCartUI() { let t = 0, c = 0; for(let k in cartData) { t += (cartData[k].price * cartData[k].qty); c += cartData[k].qty; } const f = document.getElementById('cart-float'); if(c > 0) { f.classList.remove('hidden'); document.getElementById('cart-qty').innerText = c + " items"; document.getElementById('cart-sum').innerText = "৳ " + t; } else f.classList.add('hidden'); }
        function setTip(a) { selectedTip = (selectedTip === a) ? 0 : a; document.querySelectorAll('.tip-btn').forEach(b => { b.classList.remove('bg-red-600', 'text-white'); b.classList.add('bg-slate-50'); }); if(selectedTip > 0) { const btn = document.getElementById('tip-'+a); btn.classList.replace('bg-slate-50', 'bg-red-600'); btn.classList.add('text-white'); } calculateFinalBill(); }
        function calculateFinalBill() {
            let s = 0; for(let k in cartData) { s += (cartData[k].price * cartData[k].qty); }
            const dist = getDistance(user.lat, user.lng, activeRes.lat, activeRes.lng);
            const d = Math.round(adminSettings.adminDeliveryFee + (dist * adminSettings.perKmFee) + (activeRes.deliveryCharge || 0));
            document.getElementById('bill-sub').innerText = "৳ " + s; document.getElementById('bill-delivery').innerText = "৳ " + d;
            if(selectedTip > 0) { document.getElementById('tip-row').classList.remove('hidden'); document.getElementById('bill-tip').innerText = "৳ " + selectedTip; } else document.getElementById('tip-row').classList.add('hidden');
            document.getElementById('final-bill-sum').innerText = "৳ " + (s + d + selectedTip);
        }
        function removeItem(name) { delete cartData[name]; updateCartUI(); openCheckout(); }
        function openCheckout() {
            const l = document.getElementById('checkout-items-list'); l.innerHTML = ""; let count = 0;
            for(let k in cartData) { count++; l.innerHTML += `<div class="flex justify-between items-center py-4 text-sm font-bold text-slate-700"><div class="flex items-center gap-3"><button onclick="removeItem('${k.replace(/'/g, "\\'")}')" class="w-8 h-8 bg-red-50 text-red-500 rounded-lg flex items-center justify-center transition-all active:scale-90"><i class="fas fa-trash-alt text-xs"></i></button><span>${k} x ${cartData[k].qty}</span></div><span class="font-black text-slate-800">৳ ${cartData[k].price * cartData[k].qty}</span></div>`; }
            if(count === 0) { document.getElementById('checkout-modal').classList.add('hidden'); return; }
            calculateFinalBill(); document.getElementById('checkout-modal').classList.remove('hidden');
        }
        function placeFinalOrder() {
            let its = []; for(let k in cartData) { its.push({ name: k, qty: cartData[k].qty, price: cartData[k].price }); }
            const ord = { customerName: user.name, customerPhone: user.phone, customerAddress: user.address, lat: user.lat, lng: user.lng, restaurantName: activeRes.name, restaurantId: activeRes.idNo, resLat: activeRes.lat, resLng: activeRes.lng, items: its, subtotal: document.getElementById('bill-sub').innerText.replace('৳ ', ''), deliveryCharge: document.getElementById('bill-delivery').innerText.replace('৳ ', ''), tip: selectedTip, total: document.getElementById('final-bill-sum').innerText.replace('৳ ', ''), status: "PENDING", timestamp: Date.now() };
            db.ref('orders').push(ord).then(() => { alert("সফলভাবে অর্ডার করা হয়েছে!"); cartData = {}; updateCartUI(); document.getElementById('checkout-modal').classList.add('hidden'); switchCustPage('orders'); });
        }
        function loadOrderHistory() {
            db.ref('orders').orderByChild('customerPhone').equalTo(user.phone).on('value', snap => {
                const l = document.getElementById('my-orders-list'); l.innerHTML = "";
                let ords = []; snap.forEach(c => { let o = c.val(); o.orderId = c.key; ords.push(o); });
                ords.sort((a,b) => b.timestamp - a.timestamp).forEach(o => {
                    l.innerHTML += `<div class="bg-white p-6 rounded-[2.5rem] border shadow-sm relative mb-2 animate-up flex items-center justify-between"><div class="flex-1"><span class="absolute top-4 right-6 text-[9px] font-black uppercase text-red-600 bg-red-50 px-3 py-1 rounded-full">${o.status}</span><h4 class="font-black italic uppercase text-xl text-slate-800">${o.restaurantName}</h4><p class="text-[9px] text-gray-400 font-bold mb-4 mt-2">${new Date(o.timestamp).toLocaleString()}</p><span class="text-red-600 font-black text-2xl italic">৳ ${o.total}</span></div><div class="flex flex-col gap-3 pl-4 border-l ml-2"><button onclick="openChat('${o.orderId}', '${o.riderName || 'Rider'}')" class="order-action-btn bg-emerald-50 text-emerald-600 border border-emerald-100"><i class="fas fa-comment-dots"></i></button><button onclick='trackLiveOrder(${JSON.stringify(o)})' class="order-action-btn bg-blue-50 text-blue-600 border border-blue-100"><i class="fas fa-location-dot"></i></button></div></div>`;
                });
            });
        }
        
        // ট্র্যাকিং ম্যাপেও আপডেট করা হয়েছে
        function trackLiveOrder(order) {
            document.getElementById('tracking-modal').style.display = 'flex';
            if(!tMap) { 
                tMap = L.map('tracking-map', {zoomControl: false}).setView([order.lat, order.lng], 15); 
                L.tileLayer(TILE_URL, { attribution: ATTRIBUTION }).addTo(tMap); 
            }
            else { 
                tMap.setView([order.lat, order.lng], 15); 
                tMap.eachLayer(l => { if(l instanceof L.Marker) tMap.removeLayer(l); }); 
            }
            const uI = L.divIcon({ html: '<div style="background:#ef4444; width:40px; height:40px; border-radius:20px; border:4px solid white; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-home"></i></div>', className: '', iconSize:[40,40]});
            const rI = L.divIcon({ html: '<div style="background:#1e293b; width:40px; height:40px; border-radius:20px; border:4px solid white; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-utensils"></i></div>', className: '', iconSize:[40,40]});
            const cI = L.divIcon({ html: '<div style="background:#22c55e; width:45px; height:45px; border-radius:22px; border:4px solid white; display:flex; align-items:center; justify-content:center; color:white; box-shadow: 0 5px 15px rgba(0,0,0,0.2);"><i class="fas fa-motorcycle text-xl"></i></div>', className: '', iconSize:[45,45]});
            L.marker([order.lat, order.lng], {icon: uI}).addTo(tMap);
            L.marker([order.resLat, order.resLng], {icon: rI}).addTo(tMap);
            if (riderListener) riderListener.off(); riderMarker = null;
            db.ref(`orders/${order.orderId}`).on('value', oS => {
                const cO = oS.val();
                if(cO.riderId) {
                    document.getElementById('track-chat-btn').onclick = () => openChat(order.orderId, cO.riderName || "Rider");
                    riderListener = db.ref(`riders/${cO.riderId}`);
                    riderListener.on('value', rS => { const rD = rS.val(); if(rD && rD.lat) { document.getElementById('track-rider-name').innerText = rD.name; document.getElementById('track-rider-call').href = "tel:" + rD.phone; const pos = [rD.lat, rD.lng]; if(riderMarker) riderMarker.setLatLng(pos); else riderMarker = L.marker(pos, {icon: cI}).addTo(tMap); } });
                } else { document.getElementById('track-rider-name').innerText = "Rider is assigning..."; }
            });
            setTimeout(() => tMap.invalidateSize(), 400);
        }
        function closeTracking() { document.getElementById('tracking-modal').style.display = 'none'; if(riderListener) riderListener.off(); }
        function updateProfile() { const n = document.getElementById('prof-name').value; const pos = pMarker.getLatLng(); db.ref('users/' + user.phone).update({ name: n, lat: pos.lat, lng: pos.lng }).then(() => alert("Updated!")); }
        function handleLogout() { localStorage.clear(); location.reload(); }
        window.onload = () => { const saved = localStorage.getItem('fh_user'); if(saved) { user = JSON.parse(saved); startApp(); } else showAuth('login'); };
    </script>
</body>
</html>